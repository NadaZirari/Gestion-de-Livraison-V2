<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog 
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.1.xsd">

    <!-- This changelog is intentionally left empty as the delivery_history table 
         was already created in db.changelog-v2.0-new-entities.xml -->
    <changeSet id="v3.0-delivery-history-updates" author="dev">
        <comment>No changes needed - table already created in v2</comment>
    </changeSet>

    <!-- Add a trigger to automatically set day_of_week from delivery_date -->
    <changeSet id="v3.0-add-day-of-week-trigger" author="dev" dbms="postgresql">
        <sql>
            CREATE OR REPLACE FUNCTION set_day_of_week()
            RETURNS TRIGGER AS $$
            BEGIN
                NEW.day_of_week := TO_CHAR(NEW.delivery_date, 'Day');
                RETURN NEW;
            END;
            $$ LANGUAGE plpgsql;
            
            CREATE TRIGGER trg_set_day_of_week
            BEFORE INSERT OR UPDATE OF delivery_date ON delivery_history
            FOR EACH ROW
            EXECUTE FUNCTION set_day_of_week();
        </sql>
        <rollback>
            DROP TRIGGER IF EXISTS trg_set_day_of_week ON delivery_history;
            DROP FUNCTION IF EXISTS set_day_of_week();
        </rollback>
    </changeSet>
    
</databaseChangeLog>
